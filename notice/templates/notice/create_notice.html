{% extends 'core/base.html' %}
{% load form_tags %}
{% block page_title %}New Notice - {{ app_name }}{% endblock %}
{% block content %}
<div class="container">
    <h2>Create New Notice</h2>
    {% if messages %}
      {% for message in messages %}
        <div class="alert alert-{% if message.tags == 'error' %}danger{% else %}{{ message.tags }}{% endif %} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    {% endif %}
    <form method="post" enctype="multipart/form-data" class="mt-3">
        {% csrf_token %}
        <div class="row">
            <div class="col-md-6 mb-3">
                {{ form.title.label_tag }}
                <input type="text" name="title" id="id_title" class="form-control{% if form.title.errors %} is-invalid{% endif %}" required minlength="5" maxlength="200" value="{{ form.title.value|default:'' }}">
                {% if form.title.help_text %}<small class="form-text text-muted">{{ form.title.help_text }}</small>{% endif %}
                {% if form.title.errors %}<div class="invalid-feedback">{{ form.title.errors.0 }}</div>{% endif %}
            </div>
            <div class="col-md-6 mb-3">
                {{ form.priority.label_tag }}
                <input type="number" name="priority" id="id_priority" class="form-control{% if form.priority.errors %} is-invalid{% endif %}" required min="1" max="10" value="{{ form.priority.value|default:'' }}">
                {% if form.priority.help_text %}<small class="form-text text-muted">{{ form.priority.help_text }}</small>{% endif %}
                {% if form.priority.errors %}<div class="invalid-feedback">{{ form.priority.errors.0 }}</div>{% endif %}
            </div>
        </div>
        <div class="row">
            <div class="col-md-12 mb-3">
                {{ form.content.label_tag }}
                <textarea name="content" id="id_content" class="form-control{% if form.content.errors %} is-invalid{% endif %}" required minlength="10" maxlength="2000" rows="5">{{ form.content.value|default:'' }}</textarea>
                {% if form.content.help_text %}<small class="form-text text-muted">{{ form.content.help_text }}</small>{% endif %}
                {% if form.content.errors %}<div class="invalid-feedback">{{ form.content.errors.0 }}</div>{% endif %}
            </div>
        </div>
        <div class="row">
            <div class="col-md-4 mb-3">
                {{ form.audience.label_tag }}
                {{ form.audience|add_class:'form-select' }}
                {% if form.audience.help_text %}<small class="form-text text-muted">{{ form.audience.help_text }}</small>{% endif %}
                {% if form.audience.errors %}<div class="invalid-feedback d-block">{{ form.audience.errors.0 }}</div>{% endif %}
            </div>
            <div class="col-md-4 mb-3">
                {{ form.iwi.label_tag }}
                {{ form.iwi|add_class:'form-select' }}
                {% if form.iwi.help_text %}<small class="form-text text-muted">{{ form.iwi.help_text }}</small>{% endif %}
                {% if form.iwi.errors %}<div class="invalid-feedback d-block">{{ form.iwi.errors.0 }}</div>{% endif %}
            </div>
            <div class="col-md-4 mb-3">
                {{ form.hapu.label_tag }}
                {{ form.hapu|add_class:'form-select' }}
                {% if form.hapu.help_text %}<small class="form-text text-muted">{{ form.hapu.help_text }}</small>{% endif %}
                {% if form.hapu.errors %}<div class="invalid-feedback d-block">{{ form.hapu.errors.0 }}</div>{% endif %}
            </div>
        </div>
        <div class="row">
            <div class="col-md-6 mb-3">
                {{ form.expiry_date.label_tag }}
                <input type="datetime-local" name="expiry_date" id="id_expiry_date" class="form-control{% if form.expiry_date.errors %} is-invalid{% endif %}" required value="{{ form.expiry_date.value|default:'' }}">
                {% if form.expiry_date.help_text %}<small class="form-text text-muted">{{ form.expiry_date.help_text }}</small>{% endif %}
                {% if form.expiry_date.errors %}<div class="invalid-feedback">{{ form.expiry_date.errors.0 }}</div>{% endif %}
            </div>
            <div class="col-md-6 mb-3">
                {{ form.attachment.label_tag }}
                <input type="file" name="attachment" id="id_attachment" class="form-control{% if form.attachment.errors %} is-invalid{% endif %}" accept=".pdf,.jpg,.jpeg,.png">
                {% if form.attachment.help_text %}<small class="form-text text-muted">{{ form.attachment.help_text }}</small>{% endif %}
                {% if form.attachment.errors %}<div class="invalid-feedback">{{ form.attachment.errors.0 }}</div>{% endif %}
            </div>
        </div>
        <button type="submit" class="btn btn-primary">Create Notice</button>
    </form>
</div>
{% endblock %}
{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    function updateIwiHapuFields() {
      const audience = document.getElementById('id_audience');
      const iwi = document.getElementById('id_iwi');
      const hapu = document.getElementById('id_hapu');
      if (!audience || !iwi || !hapu) return;
      if (audience.value === 'ALL') {
        iwi.disabled = true;
        hapu.disabled = true;
      } else if (audience.value === 'IWI') {
        iwi.disabled = false;
        hapu.disabled = true;
      } else if (audience.value === 'HAPU') {
        iwi.disabled = false;
        hapu.disabled = false;
      }
    }
    const audience = document.getElementById('id_audience');
    if (audience) {
      audience.addEventListener('change', updateIwiHapuFields);
      updateIwiHapuFields();
    }
    // File validation
    const fileInput = document.getElementById('id_attachment');
    if (fileInput) {
      fileInput.addEventListener('change', function() {
        const file = fileInput.files[0];
        if (file) {
          const validTypes = ['application/pdf', 'image/jpeg', 'image/png'];
          if (!validTypes.includes(file.type)) {
            alert('Only PDF, JPG, or PNG files are allowed.');
            fileInput.value = '';
          } else if (file.size > 2 * 1024 * 1024) {
            alert('File size must be under 2MB.');
            fileInput.value = '';
          }
        }
      });
    }
  });
</script>
{% endblock %} 